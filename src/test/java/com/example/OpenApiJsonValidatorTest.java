package com.example;

import com.example.openapi.validator.JsonValidatorResult;
import com.example.openapi.validator.OpenApiJsonValidator;
import org.junit.Assert;
import org.junit.Test;

import java.io.IOException;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

public class OpenApiJsonValidatorTest {

    @Test
    public void success() throws IOException {
        String schema = "{\"openapi\":\"3.0.1\",\"info\":{\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"version\":\"1.0.6\"},\"paths\":{\"/meta/rootinstall\":{\"post\":{\"summary\":\"Save TIPS Intsall\",\"requestBody\":{\"description\":\"TIPS Intsall\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/rootinstall\"}}},\"required\":true},\"responses\":{\"200\":{\"$ref\":\"#/components/schemas/rootinstall\"}}}}},\"components\":{\"schemas\":{\"rootinstall\":{\"required\":[\"fcmCapabilities\",\"transactParameters\"],\"type\":\"object\",\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"properties\":{\"fcmCapabilities\":{\"$ref\":\"#/components/schemas/fcmCapabilities\"},\"transactParameters\":{\"$ref\":\"#/components/schemas/transactParameters\"}}},\"fcmCapabilities\":{\"title\":\"FCM Capabilities\",\"required\":[\"fcmModules\"],\"type\":\"object\",\"properties\":{\"fcmModules\":{\"type\":\"array\",\"title\":\"FCM services\",\"description\":\"Do you wish the service to perform transaction screening on payments?\",\"default\":[],\"items\":{\"type\":\"string\",\"enum\":[\"Transaction Screening\"],\"minItems\":0,\"uniqueItems\":true}}}},\"transactParameters\":{\"title\":\"Core parameters\",\"required\":[\"institutionName\",\"institutionAddressLine1\",\"language\",\"localCountryCode\",\"localCurrency\",\"systemStartDate\",\"financialYearEnd\"],\"type\":\"object\",\"properties\":{\"institutionName\":{\"type\":\"string\",\"title\":\"Institution Name\",\"description\":\"What is your institution name?\",\"default\":\"Temenos Demo Bank\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine1\":{\"type\":\"string\",\"title\":\"Institution Address Line 1\",\"description\":\"What is your institution's address?\",\"default\":\"Rue de l'Ecole-de-Chimie 2\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine2\":{\"type\":\"string\",\"title\":\"Institution Address Line 2\",\"description\":\"What is your institution's address?\",\"default\":\"1205 Genève\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine3\":{\"type\":\"string\",\"title\":\"Institution Address Line 3\",\"description\":\"What is your institution's address?\",\"default\":\"Switzerland\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine4\":{\"type\":\"string\",\"title\":\"Institution Address Line 4\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine5\":{\"type\":\"string\",\"title\":\"Institution Address Line 5\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"language\":{\"type\":\"string\",\"title\":\"Langauge\",\"description\":\"What is the prefered langauge?\",\"default\":\"GB\",\"enum\":[\"GB\",\"FR\",\"DE\"]},\"localCountryCode\":{\"type\":\"string\",\"title\":\"Local Country\",\"description\":\"What is the local country?\",\"default\":\"GB\",\"enum\":[\"US\",\"GB\",\"CH\",\"IN\",\"DE\"]},\"localCurrency\":{\"type\":\"string\",\"title\":\"Local Currency\",\"description\":\"What is the local currency?\",\"default\":\"GBP\",\"enum\":[\"USD\",\"GBP\",\"CHF\",\"INR\",\"EUR\"]},\"systemStartDate\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"System Start Date\",\"description\":\"What will be your system's start date?\",\"example\":\"2021-09-01,\"},\"financialYearEnd\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"Financial Year End\",\"description\":\"What date will be your Financial Year End?\",\"example\":\"2021-12-31,\"},\"swiftCode\":{\"type\":\"string\",\"title\":\"SWIFT Code\",\"description\":\"What is your institution's SWIFT code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11},\"telexCode\":{\"type\":\"string\",\"title\":\"Telex Code\",\"description\":\"What is your institution's Telex code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11}}}}}}";
        String json = "{\"fcmCapabilities\":{\"fcmModules\":[\"Transaction Screening\"]},\"transactParameters\":{\"institutionName\":\"Temenos Demo Bank,\",\"institutionAddressLine1\":\"Rue de l'Ecole-de-Chimie 2\",\"language\":\"GB\",\"localCountryCode\":\"GB\",\"localCurrency\":\"GBP\",\"systemStartDate\":\"2021-09-01\",\"financialYearEnd\":\"2021-12-31\"}}";

        OpenApiJsonValidator validator = new OpenApiJsonValidator();
        JsonValidatorResult result = validator.validate(schema, json, "rootinstall");

        Assert.assertFalse(result.hasErrors());
    }

    @Test
    public void failure_enumValidation() throws IOException {
        String schema = "{\"openapi\":\"3.0.1\",\"info\":{\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"version\":\"1.0.6\"},\"paths\":{\"/meta/rootinstall\":{\"post\":{\"summary\":\"Save TIPS Intsall\",\"requestBody\":{\"description\":\"TIPS Intsall\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/rootinstall\"}}},\"required\":true},\"responses\":{\"200\":{\"$ref\":\"#/components/schemas/rootinstall\"}}}}},\"components\":{\"schemas\":{\"rootinstall\":{\"required\":[\"fcmCapabilities\",\"transactParameters\"],\"type\":\"object\",\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"properties\":{\"fcmCapabilities\":{\"$ref\":\"#/components/schemas/fcmCapabilities\"},\"transactParameters\":{\"$ref\":\"#/components/schemas/transactParameters\"}}},\"fcmCapabilities\":{\"title\":\"FCM Capabilities\",\"required\":[\"fcmModules\"],\"type\":\"object\",\"properties\":{\"fcmModules\":{\"type\":\"array\",\"title\":\"FCM services\",\"description\":\"Do you wish the service to perform transaction screening on payments?\",\"default\":[],\"items\":{\"type\":\"string\",\"enum\":[\"Transaction Screening\"],\"minItems\":0,\"uniqueItems\":true}}}},\"transactParameters\":{\"title\":\"Core parameters\",\"required\":[\"institutionName\",\"institutionAddressLine1\",\"language\",\"localCountryCode\",\"localCurrency\",\"systemStartDate\",\"financialYearEnd\"],\"type\":\"object\",\"properties\":{\"institutionName\":{\"type\":\"string\",\"title\":\"Institution Name\",\"description\":\"What is your institution name?\",\"default\":\"Temenos Demo Bank\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine1\":{\"type\":\"string\",\"title\":\"Institution Address Line 1\",\"description\":\"What is your institution's address?\",\"default\":\"Rue de l'Ecole-de-Chimie 2\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine2\":{\"type\":\"string\",\"title\":\"Institution Address Line 2\",\"description\":\"What is your institution's address?\",\"default\":\"1205 Genève\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine3\":{\"type\":\"string\",\"title\":\"Institution Address Line 3\",\"description\":\"What is your institution's address?\",\"default\":\"Switzerland\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine4\":{\"type\":\"string\",\"title\":\"Institution Address Line 4\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine5\":{\"type\":\"string\",\"title\":\"Institution Address Line 5\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"language\":{\"type\":\"string\",\"title\":\"Langauge\",\"description\":\"What is the prefered langauge?\",\"default\":\"GB\",\"enum\":[\"GB\",\"FR\",\"DE\"]},\"localCountryCode\":{\"type\":\"string\",\"title\":\"Local Country\",\"description\":\"What is the local country?\",\"default\":\"GB\",\"enum\":[\"US\",\"GB\",\"CH\",\"IN\",\"DE\"]},\"localCurrency\":{\"type\":\"string\",\"title\":\"Local Currency\",\"description\":\"What is the local currency?\",\"default\":\"GBP\",\"enum\":[\"USD\",\"GBP\",\"CHF\",\"INR\",\"EUR\"]},\"systemStartDate\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"System Start Date\",\"description\":\"What will be your system's start date?\",\"example\":\"2021-09-01,\"},\"financialYearEnd\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"Financial Year End\",\"description\":\"What date will be your Financial Year End?\",\"example\":\"2021-12-31,\"},\"swiftCode\":{\"type\":\"string\",\"title\":\"SWIFT Code\",\"description\":\"What is your institution's SWIFT code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11},\"telexCode\":{\"type\":\"string\",\"title\":\"Telex Code\",\"description\":\"What is your institution's Telex code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11}}}}}}";
        String json = "{\"fcmCapabilities\":{\"fcmModules\":[\"Transaction Screening1\"]},\"transactParameters\":{\"institutionName\":\"Temenos Demo Bank,\",\"institutionAddressLine1\":\"Rue de l'Ecole-de-Chimie 2\",\"language\":\"GB\",\"localCountryCode\":\"GB\",\"localCurrency\":\"GBP\",\"systemStartDate\":\"2021-09-01\",\"financialYearEnd\":\"2021-12-31\"}}";

        OpenApiJsonValidator validator = new OpenApiJsonValidator();
        JsonValidatorResult result = validator.validate(schema, json, "rootinstall");

        System.out.println(result.getErrors());
        assertTrue(result.hasErrors());
        assertEquals(1, result.errorCount());
        assertTrue(result.getErrors().get(0).contains("is not a valid enum value"));
    }

    @Test
    public void failure_multipleValidationError() throws IOException {
        String schema = "{\"openapi\":\"3.0.1\",\"info\":{\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"version\":\"1.0.6\"},\"paths\":{\"/meta/rootinstall\":{\"post\":{\"summary\":\"Save TIPS Intsall\",\"requestBody\":{\"description\":\"TIPS Intsall\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/rootinstall\"}}},\"required\":true},\"responses\":{\"200\":{\"$ref\":\"#/components/schemas/rootinstall\"}}}}},\"components\":{\"schemas\":{\"rootinstall\":{\"required\":[\"fcmCapabilities\",\"transactParameters\"],\"type\":\"object\",\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"properties\":{\"fcmCapabilities\":{\"$ref\":\"#/components/schemas/fcmCapabilities\"},\"transactParameters\":{\"$ref\":\"#/components/schemas/transactParameters\"}}},\"fcmCapabilities\":{\"title\":\"FCM Capabilities\",\"required\":[\"fcmModules\"],\"type\":\"object\",\"properties\":{\"fcmModules\":{\"type\":\"array\",\"title\":\"FCM services\",\"description\":\"Do you wish the service to perform transaction screening on payments?\",\"default\":[],\"items\":{\"type\":\"string\",\"enum\":[\"Transaction Screening\"],\"minItems\":0,\"uniqueItems\":true}}}},\"transactParameters\":{\"title\":\"Core parameters\",\"required\":[\"institutionName\",\"institutionAddressLine1\",\"language\",\"localCountryCode\",\"localCurrency\",\"systemStartDate\",\"financialYearEnd\"],\"type\":\"object\",\"properties\":{\"institutionName\":{\"type\":\"string\",\"title\":\"Institution Name\",\"description\":\"What is your institution name?\",\"default\":\"Temenos Demo Bank\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine1\":{\"type\":\"string\",\"title\":\"Institution Address Line 1\",\"description\":\"What is your institution's address?\",\"default\":\"Rue de l'Ecole-de-Chimie 2\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine2\":{\"type\":\"string\",\"title\":\"Institution Address Line 2\",\"description\":\"What is your institution's address?\",\"default\":\"1205 Genève\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine3\":{\"type\":\"string\",\"title\":\"Institution Address Line 3\",\"description\":\"What is your institution's address?\",\"default\":\"Switzerland\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine4\":{\"type\":\"string\",\"title\":\"Institution Address Line 4\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine5\":{\"type\":\"string\",\"title\":\"Institution Address Line 5\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"language\":{\"type\":\"string\",\"title\":\"Langauge\",\"description\":\"What is the prefered langauge?\",\"default\":\"GB\",\"enum\":[\"GB\",\"FR\",\"DE\"]},\"localCountryCode\":{\"type\":\"string\",\"title\":\"Local Country\",\"description\":\"What is the local country?\",\"default\":\"GB\",\"enum\":[\"US\",\"GB\",\"CH\",\"IN\",\"DE\"]},\"localCurrency\":{\"type\":\"string\",\"title\":\"Local Currency\",\"description\":\"What is the local currency?\",\"default\":\"GBP\",\"enum\":[\"USD\",\"GBP\",\"CHF\",\"INR\",\"EUR\"]},\"systemStartDate\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"System Start Date\",\"description\":\"What will be your system's start date?\",\"example\":\"2021-09-01,\"},\"financialYearEnd\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"Financial Year End\",\"description\":\"What date will be your Financial Year End?\",\"example\":\"2021-12-31,\"},\"swiftCode\":{\"type\":\"string\",\"title\":\"SWIFT Code\",\"description\":\"What is your institution's SWIFT code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11},\"telexCode\":{\"type\":\"string\",\"title\":\"Telex Code\",\"description\":\"What is your institution's Telex code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11}}}}}}";
        String json = "{\"transactParameters\":{\"institutionName\":\"Temenos Demo Bank,\",\"institutionAddressLine1\":\"Rue de l'Ecole-de-Chimie 2\",\"language\":\"GB1\",\"localCountryCode\":\"GB\",\"localCurrency\":\"GBP\",\"systemStartDate\":\"2021-09-01\",\"financialYearEnd\":\"2021-12-31\"}}";

        OpenApiJsonValidator validator = new OpenApiJsonValidator();
        JsonValidatorResult result = validator.validate(schema, json, "rootinstall");

        System.out.println(result.getErrors().get(0));
        System.out.println(result.getErrors().get(1));

        assertTrue(result.hasErrors());
        assertEquals(2, result.errorCount());
        assertTrue(result.getErrors().get(0).contains("required key [fcmCapabilities] not found"));
        assertTrue(result.getErrors().get(1).contains("is not a valid enum value"));
    }

    @Test
    public void failure_dateValidation() throws IOException {
        String schema = "{\"openapi\":\"3.0.1\",\"info\":{\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"version\":\"1.0.6\"},\"paths\":{\"/meta/rootinstall\":{\"post\":{\"summary\":\"Save TIPS Intsall\",\"requestBody\":{\"description\":\"TIPS Intsall\",\"content\":{\"*/*\":{\"schema\":{\"$ref\":\"#/components/schemas/rootinstall\"}}},\"required\":true},\"responses\":{\"200\":{\"$ref\":\"#/components/schemas/rootinstall\"}}}}},\"components\":{\"schemas\":{\"rootinstall\":{\"required\":[\"fcmCapabilities\",\"transactParameters\"],\"type\":\"object\",\"title\":\"TIPS Installation Specification\",\"description\":\"TIPS - Installation\",\"properties\":{\"fcmCapabilities\":{\"$ref\":\"#/components/schemas/fcmCapabilities\"},\"transactParameters\":{\"$ref\":\"#/components/schemas/transactParameters\"}}},\"fcmCapabilities\":{\"title\":\"FCM Capabilities\",\"required\":[\"fcmModules\"],\"type\":\"object\",\"properties\":{\"fcmModules\":{\"type\":\"array\",\"title\":\"FCM services\",\"description\":\"Do you wish the service to perform transaction screening on payments?\",\"default\":[],\"items\":{\"type\":\"string\",\"enum\":[\"Transaction Screening\"],\"minItems\":0,\"uniqueItems\":true}}}},\"transactParameters\":{\"title\":\"Core parameters\",\"required\":[\"institutionName\",\"institutionAddressLine1\",\"language\",\"localCountryCode\",\"localCurrency\",\"systemStartDate\",\"financialYearEnd\"],\"type\":\"object\",\"properties\":{\"institutionName\":{\"type\":\"string\",\"title\":\"Institution Name\",\"description\":\"What is your institution name?\",\"default\":\"Temenos Demo Bank\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine1\":{\"type\":\"string\",\"title\":\"Institution Address Line 1\",\"description\":\"What is your institution's address?\",\"default\":\"Rue de l'Ecole-de-Chimie 2\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine2\":{\"type\":\"string\",\"title\":\"Institution Address Line 2\",\"description\":\"What is your institution's address?\",\"default\":\"1205 Genève\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine3\":{\"type\":\"string\",\"title\":\"Institution Address Line 3\",\"description\":\"What is your institution's address?\",\"default\":\"Switzerland\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine4\":{\"type\":\"string\",\"title\":\"Institution Address Line 4\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"institutionAddressLine5\":{\"type\":\"string\",\"title\":\"Institution Address Line 5\",\"description\":\"What is your institution's address?\",\"minLength\":1,\"maxLength\":128},\"language\":{\"type\":\"string\",\"title\":\"Langauge\",\"description\":\"What is the prefered langauge?\",\"default\":\"GB\",\"enum\":[\"GB\",\"FR\",\"DE\"]},\"localCountryCode\":{\"type\":\"string\",\"title\":\"Local Country\",\"description\":\"What is the local country?\",\"default\":\"GB\",\"enum\":[\"US\",\"GB\",\"CH\",\"IN\",\"DE\"]},\"localCurrency\":{\"type\":\"string\",\"title\":\"Local Currency\",\"description\":\"What is the local currency?\",\"default\":\"GBP\",\"enum\":[\"USD\",\"GBP\",\"CHF\",\"INR\",\"EUR\"]},\"systemStartDate\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"System Start Date\",\"description\":\"What will be your system's start date?\",\"example\":\"2021-09-01,\"},\"financialYearEnd\":{\"type\":\"string\",\"format\":\"date\",\"title\":\"Financial Year End\",\"description\":\"What date will be your Financial Year End?\",\"example\":\"2021-12-31,\"},\"swiftCode\":{\"type\":\"string\",\"title\":\"SWIFT Code\",\"description\":\"What is your institution's SWIFT code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11},\"telexCode\":{\"type\":\"string\",\"title\":\"Telex Code\",\"description\":\"What is your institution's Telex code?\",\"default\":\"TEMNGBXXXX\",\"minLength\":1,\"maxLength\":11}}}}}}";
        String json = "{\"fcmCapabilities\":{\"fcmModules\":[\"Transaction Screening\"]},\"transactParameters\":{\"institutionName\":\"Temenos Demo Bank,\",\"institutionAddressLine1\":\"Rue de l'Ecole-de-Chimie 2\",\"language\":\"GB\",\"localCountryCode\":\"GB\",\"localCurrency\":\"GBP\",\"systemStartDate\":\"2021-13-01\",\"financialYearEnd\":\"2021:12:31\"}}";

        OpenApiJsonValidator validator = new OpenApiJsonValidator();
        JsonValidatorResult result = validator.validate(schema, json, "rootinstall");

        System.out.println(result.getErrors().get(0));
        System.out.println(result.getErrors().get(1));

        Assert.assertTrue(result.hasErrors());
        assertEquals(2, result.errorCount());
        assertTrue(result.getErrors().get(0).contains("[2021:12:31] is not a valid date. Expected [yyyy-MM-dd]"));
        assertTrue(result.getErrors().get(1).contains("[2021-13-01] is not a valid date. Expected [yyyy-MM-dd]"));
    }

}
